# Pre-commit configuration for knapsack-gnn
# Install: pre-commit install && pre-commit install --hook-type pre-push
#
# Staged approach:
# - Pre-commit: Fast auto-fixes (<2s), block on non-fixable errors
# - Pre-push: Type checking, quick tests, dependency sync check
#
# To skip hooks temporarily: SKIP=mypy,tests git commit/push

repos:
  # ============================================================================
  # Pre-commit stage: Fast formatting and linting
  # ============================================================================

  # Ruff: Fast Python linter and formatter (replaces black, isort, flake8)
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.9.1
    hooks:
      # Format code (replaces black)
      - id: ruff-format
        name: ruff format (auto-fix)
        files: ^(src/|experiments/|tests/)
        exclude: ^(checkpoints/|data/|docs/_assets/|\.venv/)

      # Lint and auto-fix issues (replaces flake8, isort)
      - id: ruff
        name: ruff lint (auto-fix)
        args: [--fix, --exit-non-zero-on-fix, --unsafe-fixes]
        files: ^(src/|experiments/|tests/)
        exclude: ^(checkpoints/|data/|docs/_assets/|\.venv/)

  # Basic file hygiene
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v5.0.0
    hooks:
      - id: end-of-file-fixer
        exclude: ^(checkpoints/|data/|\.pytest_cache/)
      - id: trailing-whitespace
        exclude: ^(checkpoints/|data/|\.pytest_cache/)
        args: [--markdown-linebreak-ext=md]
      - id: check-merge-conflict

      - id: check-toml
      - id: check-added-large-files
        args: [--maxkb=1000]
      - id: mixed-line-ending
        args: [--fix=lf]

  - repo: https://github.com/adrienverge/yamllint
    rev: v1.35.1
    hooks:
      - id: yamllint
        files: .yamllint mkdocs.yml

  # Commit message linting (Conventional Commits)
  - repo: https://github.com/alessandrojcm/commitlint-pre-commit-hook
    rev: v9.5.0
    hooks:
      - id: commitlint
        name: commitlint (conventional commits)
        stages: [commit-msg]
        additional_dependencies: ['@commitlint/config-conventional']

  # ============================================================================
  # Pre-push stage: Heavier checks (type checking, tests, dependency sync)
  # ============================================================================

  - repo: local
    hooks:
      # Type checking with mypy
      - id: mypy
        name: mypy type check (pre-push)
        entry: mypy src/knapsack_gnn/ experiments/ --ignore-missing-imports
        language: python
        pass_filenames: false
        stages: [pre-push]
        additional_dependencies: [mypy]

      # Run quick tests (exclude slow tests)
      - id: pytest-quick
        name: pytest quick tests (pre-push)
        entry: pytest tests/ -q -m 'not slow' --maxfail=3
        language: python
        pass_filenames: false
        stages: [pre-push]
        additional_dependencies: [pytest, pytest-cov, numpy, torch, ortools, torch-geometric]

      # Check dependency drift
      - id: check-deps
        name: check dependency sync (pre-push)
        entry: uv pip check
        language: python
        pass_filenames: false
        stages: [pre-push]
        files: ^(pyproject\.toml|requirements.*\.txt)$
        additional_dependencies: [uv]

# Global settings
default_language_version:
  python: python3

# Skip these hooks by default (can be overridden per-hook)
# To run all including slow: SKIP= pre-commit run --all-files
exclude: |
  (?x)^(
      checkpoints/.*|
      data/.*|
      docs/_assets/.*|
      \.pytest_cache/.*|
      \.mypy_cache/.*|
      \.ruff_cache/.*|
      __pycache__/.*|
      .*\.egg-info/.*
  )$

# CI mode: skip slow hooks in CI if needed
ci:
  skip: []
  autofix_commit_msg: |
    [pre-commit.ci] auto fixes from pre-commit hooks

    for more information, see https://pre-commit.ci
